#include <setjmp.h>
#include <stdarg.h>
#include <stddef.h>
#include <stdint.h>
#include <stdlib.h>

#include <cmocka.h>
#include <stdio.h>

#include "jdwp.h"

#include <string.h>
#include <unistd.h>

// This is a redefinition of AnotherClass.java
// It replaces the square method with a negated version.
static uint8_t redefined_class[] = {
    0xca, 0xfe, 0xba, 0xbe, 0x00, 0x00, 0x00, 0x43, 0x00, 0x0f, 0x0a, 0x00,
    0x02, 0x00, 0x03, 0x07, 0x00, 0x04, 0x0c, 0x00, 0x05, 0x00, 0x06, 0x01,
    0x00, 0x10, 0x6a, 0x61, 0x76, 0x61, 0x2f, 0x6c, 0x61, 0x6e, 0x67, 0x2f,
    0x4f, 0x62, 0x6a, 0x65, 0x63, 0x74, 0x01, 0x00, 0x06, 0x3c, 0x69, 0x6e,
    0x69, 0x74, 0x3e, 0x01, 0x00, 0x03, 0x28, 0x29, 0x56, 0x07, 0x00, 0x08,
    0x01, 0x00, 0x0c, 0x41, 0x6e, 0x6f, 0x74, 0x68, 0x65, 0x72, 0x43, 0x6c,
    0x61, 0x73, 0x73, 0x01, 0x00, 0x04, 0x43, 0x6f, 0x64, 0x65, 0x01, 0x00,
    0x0f, 0x4c, 0x69, 0x6e, 0x65, 0x4e, 0x75, 0x6d, 0x62, 0x65, 0x72, 0x54,
    0x61, 0x62, 0x6c, 0x65, 0x01, 0x00, 0x06, 0x73, 0x71, 0x75, 0x61, 0x72,
    0x65, 0x01, 0x00, 0x04, 0x28, 0x49, 0x29, 0x49, 0x01, 0x00, 0x0a, 0x53,
    0x6f, 0x75, 0x72, 0x63, 0x65, 0x46, 0x69, 0x6c, 0x65, 0x01, 0x00, 0x11,
    0x41, 0x6e, 0x6f, 0x74, 0x68, 0x65, 0x72, 0x43, 0x6c, 0x61, 0x73, 0x73,
    0x2e, 0x6a, 0x61, 0x76, 0x61, 0x00, 0x21, 0x00, 0x07, 0x00, 0x02, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x01, 0x00, 0x05, 0x00, 0x06, 0x00,
    0x01, 0x00, 0x09, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x01, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x05, 0x2a, 0xb7, 0x00, 0x01, 0xb1, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x0a, 0x00, 0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x0b, 0x00, 0x0c, 0x00, 0x01, 0x00, 0x09, 0x00, 0x00,
    0x00, 0x1d, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x05, 0x1b, 0x1b,
    0x68, 0x74, 0xac, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0a, 0x00, 0x00, 0x00,
    0x06, 0x00, 0x01, 0x00, 0x00, 0x00, 0x04, 0x00, 0x01, 0x00, 0x0d, 0x00,
    0x00, 0x00, 0x02, 0x00, 0x0e};

typedef struct {
  int should_exit;
  uint8_t has_ref_id;
  uint64_t ref_id;
} State;

static int setup(void **state) {
  *state = malloc(sizeof(State));
  ((State *)*state)->should_exit = 0;
  ((State *)*state)->has_ref_id = 0;
  return 0;
}

static int teardown(void **state) {
  free(*state);
  return 0;
}

void reply_callback(JdwpReply *reply, void **state) {
  State *s = *state;

  if (reply->type == JDWP_VIRTUAL_MACHINE_CLASSES_BY_SIGNATURE) {
    assert_int_equal(reply->error, JDWP_ERR_NONE);
    s->ref_id = ((JdwpVirtualMachineClassesBySignatureData *)reply->data)
                    ->classes_data[0]
                    .type_id;
    s->has_ref_id = 1;
  }

  if (reply->type == JDWP_VIRTUAL_MACHINE_REDEFINE_CLASSES) {
    assert_int_equal(reply->error, JDWP_ERR_NONE);
    s->should_exit = 1;
  }

  jdwp_reply_free(&reply);
}

static void test(void **state) {
  JdwpClient client;
  State *st = *state;
  JdwpLibError err = jdwp_client_new(&client);
  assert_int_equal(err, JDWP_LIB_ERR_NONE);

  err = jdwp_client_set_callback(client, reply_callback, state);
  assert_int_equal(err, JDWP_LIB_ERR_NONE);

  err = jdwp_client_connect(client, "127.0.0.1", 8000);
  assert_int_equal(err, JDWP_LIB_ERR_NONE);

  // Get ref ID for AnotherClass
  uint32_t id;
  JdwpVirtualMachineClassesBySignatureCommand c_cmd = {.signature =
                                                           "LAnotherClass;"};
  err = jdwp_client_send(client, &id, JDWP_VIRTUAL_MACHINE_CLASSES_BY_SIGNATURE,
                         &c_cmd);
  assert_int_equal(err, JDWP_LIB_ERR_NONE);

  while (!st->has_ref_id) {
  }

  JdwpVirtualMachineRedefineClassesClassData obj = {
      .ref_type = st->ref_id,
      .classfile = sizeof(redefined_class) / sizeof(redefined_class[0]),
      .classfile_data = redefined_class,
  };
  JdwpVirtualMachineRedefineClassesCommand cmd = {
      .classes = 1,
      .classes_data = &obj,
  };

  err = jdwp_client_send(client, &id, JDWP_VIRTUAL_MACHINE_REDEFINE_CLASSES,
                         &cmd);
  assert_int_equal(err, JDWP_LIB_ERR_NONE);

  while (!st->should_exit) {
  }

  err = jdwp_client_disconnect(client);
  assert_int_equal(err, JDWP_LIB_ERR_NONE);
  jdwp_client_free(&client);
}

int main(void) {
  const struct CMUnitTest tests[] = {
      cmocka_unit_test_setup_teardown(test, setup, teardown)};

  return cmocka_run_group_tests(tests, NULL, NULL);
}
