#include "msg/virtual_machine/redefine_classes.h"

#include <setjmp.h>
#include <stdarg.h>
#include <stddef.h>
#include <stdint.h>
#include <stdlib.h>

#include <cmocka.h>

static uint8_t class_file[] = {
    0xca, 0xfe, 0xba, 0xbe, 0x00, 0x00, 0x00, 0x43, 0x00, 0x0f, 0x0a, 0x00,
    0x02, 0x00, 0x03, 0x07, 0x00, 0x04, 0x0c, 0x00, 0x05, 0x00, 0x06, 0x01,
    0x00, 0x10, 0x6a, 0x61, 0x76, 0x61, 0x2f, 0x6c, 0x61, 0x6e, 0x67, 0x2f,
    0x4f, 0x62, 0x6a, 0x65, 0x63, 0x74, 0x01, 0x00, 0x06, 0x3c, 0x69, 0x6e,
    0x69, 0x74, 0x3e, 0x01, 0x00, 0x03, 0x28, 0x29, 0x56, 0x07, 0x00, 0x08,
    0x01, 0x00, 0x0c, 0x41, 0x6e, 0x6f, 0x74, 0x68, 0x65, 0x72, 0x43, 0x6c,
    0x61, 0x73, 0x73, 0x01, 0x00, 0x04, 0x43, 0x6f, 0x64, 0x65, 0x01, 0x00,
    0x0f, 0x4c, 0x69, 0x6e, 0x65, 0x4e, 0x75, 0x6d, 0x62, 0x65, 0x72, 0x54,
    0x61, 0x62, 0x6c, 0x65, 0x01, 0x00, 0x06, 0x73, 0x71, 0x75, 0x61, 0x72,
    0x65, 0x01, 0x00, 0x04, 0x28, 0x49, 0x29, 0x49, 0x01, 0x00, 0x0a, 0x53,
    0x6f, 0x75, 0x72, 0x63, 0x65, 0x46, 0x69, 0x6c, 0x65, 0x01, 0x00, 0x11,
    0x41, 0x6e, 0x6f, 0x74, 0x68, 0x65, 0x72, 0x43, 0x6c, 0x61, 0x73, 0x73,
    0x2e, 0x6a, 0x61, 0x76, 0x61, 0x00, 0x21, 0x00, 0x07, 0x00, 0x02, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x01, 0x00, 0x05, 0x00, 0x06, 0x00,
    0x01, 0x00, 0x09, 0x00, 0x00, 0x00, 0x1d, 0x00, 0x01, 0x00, 0x01, 0x00,
    0x00, 0x00, 0x05, 0x2a, 0xb7, 0x00, 0x01, 0xb1, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x0a, 0x00, 0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01,
    0x00, 0x01, 0x00, 0x0b, 0x00, 0x0c, 0x00, 0x01, 0x00, 0x09, 0x00, 0x00,
    0x00, 0x1d, 0x00, 0x02, 0x00, 0x02, 0x00, 0x00, 0x00, 0x05, 0x1b, 0x1b,
    0x68, 0x74, 0xac, 0x00, 0x00, 0x00, 0x01, 0x00, 0x0a, 0x00, 0x00, 0x00,
    0x06, 0x00, 0x01, 0x00, 0x00, 0x00, 0x04, 0x00, 0x01, 0x00, 0x0d, 0x00,
    0x00, 0x00, 0x02, 0x00, 0x0e};

static IdSizes id_sizes = {.reference_type_id_size = 8};

static void test_redefine_classes_serialize(void **state) {
  uint8_t *buf = NULL;
  size_t bytes_written;
  JdwpVirtualMachineRedefineClassesClassData c_data = {
      .ref_type = 1,
      .classfile = sizeof(class_file) / sizeof(class_file[0]),
      .classfile_data = class_file,
  };
  JdwpVirtualMachineRedefineClassesCommand cmd = {
      .classes = 1,
      .classes_data = &c_data,
  };
  JdwpLibError e = redefine_classes_serialize(
      &buf, &bytes_written, &cmd, JDWP_VIRTUAL_MACHINE_REDEFINE_CLASSES,
      &id_sizes, 1);

  uint8_t expected[] =
      "\000\000\001\034\000\000\000\001\000\001\022\000\000\000\001\000\000\000"
      "\000\000\000\000\001\000\000\001\001\312\376\272\276\000\000\000C\000"
      "\017\n\000\002\000\003\a\000\004\f\000\005\000\006\001\000\020java/lang/"
      "Object\001\000\006<init>\001\000\003()"
      "V\a\000\b\001\000\fAnotherClass\001\000\004Code\001\000\017LineNumberTab"
      "le\001\000\006square\001\000\004(I)"
      "I\001\000\nSourceFile\001\000\021AnotherClass.java\000!"
      "\000\a\000\002\000\000\000\000\000\002\000\001\000\005\000\006\000\001"
      "\000\t\000\000\000\035\000\001\000\001\000\000\000\005*"
      "\267\000\001\261\000\000\000\001\000\n\000\000\000\006\000\001\000\000"
      "\000\001\000\001\000\v\000\f\000\001\000\t\000\000\000\035\000\002\000"
      "\002\000\000\000\005\033\033ht\254\000\000\000\001\000\n\000\000\000\006"
      "\000\001\000\000\000\004\000\001\000\r\000\000\000\002\000\016";

  assert_int_equal(e, JDWP_LIB_ERR_NONE);
  assert_non_null(buf);
  assert_int_equal(bytes_written, 284);
  assert_memory_equal(buf, expected, 284);

  free(buf);
}

static void test_redefine_classes_deserialize(void **state) {
  uint8_t vm_reply[] = "\000\000\000\v\000\000\000\001\200\000\000";

  JdwpReply *reply;
  size_t len;
  JdwpLibError e = redefine_classes_deserialize(
      &reply, &len, vm_reply, JDWP_VIRTUAL_MACHINE_REDEFINE_CLASSES, &id_sizes);

  assert_int_equal(e, JDWP_LIB_ERR_NONE);
  assert_non_null(reply);
  assert_int_equal(reply->id, 1);
  assert_int_equal(reply->type, JDWP_VIRTUAL_MACHINE_REDEFINE_CLASSES);
  assert_int_equal(reply->error, 0);
  assert_non_null(reply->data);

  redefine_classes_free(reply);
}

int main(void) {
  const struct CMUnitTest tests[] = {
      cmocka_unit_test(test_redefine_classes_serialize),
      cmocka_unit_test(test_redefine_classes_deserialize),
  };

  return cmocka_run_group_tests(tests, NULL, NULL);
}